. env.sh
# export VAULT_TOKEN=$(grep 'Initial Root Token:' /tmp/shamir-1.txt | awk '{print $NF}')
# export VAULT_TOKEN=${VAULT_TOKEN:-'root'}
# pe "echo $VAULT_TOKEN"
# export VAULT_ADDR=http://127.0.0.1:8200

# export CONSUL_TEMPLATE_VERSION=0.22.0
# curl -s -o /tmp/consul-template.zip https://releases.hashicorp.com/consul-template/${CONSUL_TEMPLATE_VERSION}/consul-template_${CONSUL_TEMPLATE_VERSION}_linux_amd64.zip && \
#     unzip -qqo -d /usr/local/bin/ /tmp/consul-template.zip && chmod +x /usr/local/bin/consul-template


tput clear
cyan "################################################################################
# Running: $0: Vault - Direct App Integration
################################################################################\n"

cyan "#-------------------------------------------------------------------------------
# GENERATE CLIENT TOKEN
#-------------------------------------------------------------------------------\n"

# pe "vault policy write base ./vault/files/base.hcl"
tee vault/policies/db_creds.hcl <<EOF
# dynamically generated by $0
path "db-blog/creds/mother-hr-full-1h" {
    capabilities = [ "read" ]
}
path "/sys/leases/renew" {
  capabilities = [ "update" ]
}
EOF

echo
green "#--- Create a policy named db_creds."
pe "vault policy write db_creds vault/policies/db_creds.hcl"

green "#--- Generate a token with this policy attached"
pe "vault token create -policy=db_creds -ttl=1h \\
    -format=json | jq -r ".auth.client_token" | tee /tmp/token.txt"

green "[*] Remove old output"
pe "rm vault/files/tmp-customer-v2.txt"
p "Press Enter to continue..."


tput clear
cyan "#-------------------------------------------------------------------------------
# USE CONSUL TEMPLATE TO POPULATE DB CREDENTIALS
#-------------------------------------------------------------------------------\n"

green "#--- Create a template file called config.yml.tpl"
# pe "cat vault/files/customer-v2.tpl"
tee vault/policies/config.yml.tpl <<EOF
# ---
# dynamically generated by $0
{{- with secret "db-blog/creds/mother-hr-full-1h" }}
username-pp="{{ .Data.username }}"
password-pp="{{ .Data.password }}"
database-pp="myapp"
{{- end }}
EOF

echo
green "#--- Run consul template"
pe "unset VAULT_TOKEN"
pe "export VAULT_TOKEN=$(cat /tmp/token.txt)"
pe "consul-template -template=vault/policies/config.yml.tpl:vault/policies/config.yml -once"
# pe "VAULT_TOKEN=$(cat /tmp/token.txt) consul-template -template=vault/files/customer-v2.tpl:vault/files/tmp-customer-v2.txt \
#     -once"
    
    # --vault-renew-token=false

# pe "cat vault/files/tmp-customer-v2.txt"
pe "cat vault/policies/config.yml"

p "Press Enter to continue"

tput clear
cyan "#-------------------------------------------------------------------------------
# ENVCONSUL
#-------------------------------------------------------------------------------\n"

# export ENVCONSUL_VERSION=0.9.0
# curl -s -o /tmp/envconsul.zip https://releases.hashicorp.com/envconsul/${ENVCONSUL_VERSION}/envconsul_${ENVCONSUL_VERSION}_linux_amd64.zip && \
#     unzip -qqo -d /usr/local/bin/ /tmp/envconsul.zip && chmod +x /usr/local/bin/envconsul

cyan "Envconsul launches a subprocess which dynamically populates environment variables 
from secrets read from Vault. Your applications then read those environment variables. 
Despite its name, Envconsul does not require a Consul cluster to operate. 
It enables flexibility and portability for applications across systems. \n"

green "#--- Convert the customer data as environment variables:"
pe "VAULT_TOKEN=$(cat /tmp/token.txt) envconsul -upcase -secret db-blog/creds/mother-hr-full-1h env | grep DB"

yellow "NOTE: The generated environment variables are named after the secret paths as 
DB_BLOG_CREDS_MOTHER_<key>"

green "#--- Create a script file that displays the environmental variables."
tee vault/files/app.sh <<"EOF"
#!/usr/bin/env bash

tee vault/files/connection_info.txt <<EOT
My connection info is:

username: "${DB_BLOG_CREDS_MOTHER_HR_FULL_1H_USERNAME}"
password: "${DB_BLOG_CREDS_MOTHER_HR_FULL_1H_PASSWORD}"
database: "my-app"
EOT
EOF

chmod +x vault/files/app.sh

green "#--- Run the script"
pe "VAULT_TOKEN=$(cat /tmp/token.txt) envconsul -upcase -secret db-blog/creds/mother-hr-full-1h vault/files/app.sh"


